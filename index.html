<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>DentalOS • FINAL</title>

<!-- iOS WebApp & Rendering Safeguards -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="color-scheme" content="dark light">

<style>
  body {margin:0;font-family:-apple-system,"SF Pro Text",Tahoma;background:#0b0f14;color:#fff;overflow-x:hidden;}
  .dos-chip{padding:6px 12px;background:rgba(255,255,255,.08);border-radius:12px;font-weight:600}
  .dos-btn{padding:6px 12px;border:none;border-radius:8px;background:#222;color:#fff}
  .dos-btn.save{background:#34c759;color:#fff}
  .dos-mini{font-size:12px;opacity:.8}
  .dos-badge{padding:2px 6px;border-radius:8px;font-size:11px}
  .badge-blue{background:#0af;color:#fff}
  .badge-yellow{background:#fbc02d;color:#000}
  .badge-green{background:#34c759;color:#fff}
</style>
</head>
<body>
<div id="app">
  <h2 style="text-align:center">DentalOS • FINAL</h2>
  <div id="calendarRoot"></div>
  <div id="sec-patients"></div>
</div>

<!-- SafeBoot Overlay -->
<div id="safeboot-overlay" style="position:fixed;inset:0;z-index:99999;display:grid;place-items:center;background:#0b0f14;color:#fff;font-family:-apple-system,'SF Pro Text',sans-serif;">
  <div style="text-align:center;max-width:400px;padding:20px;border-radius:16px;background:rgba(255,255,255,.05);backdrop-filter:blur(10px);">
    <div style="font-weight:700;font-size:18px;margin-bottom:12px;">⚠️ این فایل باید در Safari باز شود</div>
    <div style="font-size:14px;opacity:.9;margin-bottom:16px;">اگر الان فقط صفحه خاکستری می‌بینی، یعنی فایل داخل Viewer باز شده. برای اجرا، باید مستقیم در Safari باز شود.</div>
    <button id="openSafariBtn" style="padding:12px 24px;font-size:16px;font-weight:700;border:none;border-radius:12px;background:#34c759;color:#fff;">باز کردن در Safari</button>
  </div>
</div>

<script>
// SafeBoot
(function(){
  function hideOverlay(){var sb=document.getElementById('safeboot-overlay');if(sb) sb.style.display='none';}
  if(document.readyState==='complete'||document.readyState==='interactive'){setTimeout(hideOverlay,500);}
  else{document.addEventListener('DOMContentLoaded',hideOverlay);}
  var btn=document.getElementById('openSafariBtn');
  if(btn){btn.onclick=function(){window.open(window.location.href,'_blank');};}
})();
</script>

<script>
// === Simple DB mock ===
window.DOS={db:{
  store:{patients:[],finance:[],lab:[],events:[],doctors:[{name:"مینا"},{name:"مهدی"}]},
  getAll(){return this.store;},
  put(tbl,obj){this.store[tbl]=this.store[tbl]||[];this.store[tbl].push({...obj,id:Date.now()});}
}};
</script>

<script>
// === Patients Suite with CaseID + Sync ===
(function(){
  const DOS=window.DOS;
  function genCaseID(){return 'P-'+Date.now().toString(36)+'-'+Math.floor(Math.random()*999).toString(36);}
  function renderForm(){
    const wrap=document.getElementById("sec-patients");
    const db=DOS.db.getAll();
    const doctors=(db.doctors||[]).map(d=>d.name);
    const labs=(db.lab||[{name:"ناژداکی"},{name:"هژبری"}]).map(l=>l.name);
    const caseID=genCaseID();
    wrap.innerHTML=`
      <div class="dos-chip">پرونده بیمار</div>
      <div style="display:grid;gap:10px;">
        <label>شماره پرونده: <b>${caseID}</b></label>
        <label>نام<input id="p_name"></label>
        <label>کدملی<input id="p_nid"></label>
        <label>موبایل<input id="p_mobile"></label>
        <label>پزشک<select id="p_doc">${doctors.map(n=>`<option>${n}</option>`).join("")}</select></label>
        <label>سرویس<input id="p_srv"></label>
        <label>هزینه<input type="number" id="p_cost"></label>
        <label>لابراتوار<select id="p_lab"><option value="">—</option>${labs.map(n=>`<option>${n}</option>`).join("")}</select></label>
        <button class="dos-btn save" id="p_save">ذخیره</button>
      </div>
      <div id="plist"></div>
    `;
    document.getElementById("p_save").onclick=()=>{
      const rec={
        caseID:caseID,
        name:document.getElementById("p_name").value,
        nid:document.getElementById("p_nid").value,
        mobile:document.getElementById("p_mobile").value,
        doctor:document.getElementById("p_doc").value,
        service:document.getElementById("p_srv").value,
        cost:Number(document.getElementById("p_cost").value||0),
        lab:document.getElementById("p_lab").value
      };
      DOS.db.put("patients",rec);
      DOS.db.put("finance",{patient:rec.name,doctor:rec.doctor,service:rec.service,amount:rec.cost});
      if(rec.lab){DOS.db.put("lab",{patient:rec.name,doctor:rec.doctor,labName:rec.lab,work:rec.service,cost:rec.cost});}
      DOS.db.put("events",{type:"apt",patient:rec.name,doctor:rec.doctor});
      alert("بیمار ذخیره شد و به مالی/لاب سینک شد");
      renderList();
    };
  }
  function renderList(){
    const wrap=document.getElementById("plist");
    const arr=DOS.db.getAll().patients;
    wrap.innerHTML=(arr||[]).map(p=>`
      <div style="border:1px solid #333;border-radius:12px;padding:6px;margin-top:4px">
        <b>${p.name}</b> (${p.caseID}) • دکتر: ${p.doctor} • خدمت: ${p.service} • هزینه: ${p.cost}
      </div>
    `).join("")||"<div class='dos-mini'>بیماری ثبت نشده</div>";
  }
  renderForm();
})();
</script>

<script>
// === Dummy Calendar mount (placeholder) ===
(function(){
  const root=document.getElementById("calendarRoot");
  root.innerHTML="<div class='dos-chip'>تقویم شمسی (دمو)</div>";
})();
</script>
</body>
</html>
